Menu="FileActivity:3"
Title="Disk and Pool Activity"
Tag="hdd-o"
Cond="$var['mdState'] == 'STARTED'"
---
<?php
/* Copyright 2020-2025 Dan Landon
 *
 * Permission is granted to use this software for personal, educational, or internal use only.
 * Commercial use, redistribution, or modification of this software or any derived works
 * is strictly prohibited without prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND.
 */

/* Define our plugin name. */
if (!defined('FILE_ACTIVITY_PLUGIN')) {
	define('FILE_ACTIVITY_PLUGIN', 'file.activity');
}

/* Detect Unraid version and assign a CSS class */
$unraid_version = '';
if (file_exists('/etc/unraid-version')) {
	$data = parse_ini_file('/etc/unraid-version');
	if (!empty($data['version'])) {
		$unraid_version = $data['version'];
	}
}

/* Default to legacy if not detected */
$title_class = 'legacy';

/* Compare version — 7.2 and newer = latest */
if (version_compare($unraid_version, '7.2', '>=')) {
	$title_class = 'latest';
}

$pidFile	= '/var/run/file.activity.pid';
$pidStatus	= file_exists($pidFile) ? 'Running' : 'Stopped';
$pidColor 	= $pidStatus == 'Running' ? 'green' : 'orange';
?>

<div class='<?=$title_class;?> title shift'>
	<span class='title-left'>_(Disk and Pool Activity)_</span>
	<span class='status-text'>Status: <span class='status-value' style='color:<?=$pidColor;?>;'><?=$pidStatus;?></span></span>
</div>
<?
echo $display['resize'] ? "<pre class='up' style='display:none'>" : "<pre class='up'>";

/* Parse the plugin config file. */
$file_activity_cfg	= parse_plugin_cfg(FILE_ACTIVITY_PLUGIN, true);

$display_events		= $file_activity_cfg['DISPLAY_EVENTS'] ? $file_activity_cfg['DISPLAY_EVENTS'] : "25";

$filesactive		= "";
$file_activity_log	= "/var/log/file.activity.log";

/* Disk activity. */
$disks = glob("/mnt/disk[^s]*");
natcasesort($disks);
foreach ($disks as $disk) {
	$disk_dev = $disk."/";
	$files = shell_exec("cat ".$file_activity_log." 2>/dev/null | grep ".escapeshellarg($disk_dev)." | tail -n ".escapeshellarg($display_events));
	if (!empty($files)) {
		$filesactive .= "<strong>** Disk ".substr($disk,9)." **</strong>\n";
		$filesactive .= $files;
		$filesactive .= "\n";
	}
}

/* UD disks activity. */
$files = shell_exec("cat ".$file_activity_log." 2>/dev/null | grep '/mnt/disks/'"." | tail -n ".escapeshellarg($display_events));
if (!empty($files)) {
	$filesactive .= "<strong>** Unassigned Devices"." **</strong>\n";
	$filesactive .= $files;
	$filesactive .= "\n";
}

/* Cache and pools activity. */
foreach ($pools as $pool) {
	$files = shell_exec("cat ".$file_activity_log." 2>/dev/null | grep '/mnt/".$pool."'"." | tail -n ".escapeshellarg($display_events));
	if (!empty($files)) {
		$filesactive .= "<strong>** ".ucfirst($pool)." **</strong>\n";
		$filesactive .= $files;
		$filesactive .= "\n";
	}
}

echo $filesactive;
echo "</pre>";
?>

<form name="clear log" method="POST" action="/update.php" target="progressFrame">
	<input type="button" value="_(Refresh)_" onclick="refresh()">
	<input type="hidden" name="#command" value="/plugins/file.activity/scripts/rc.file.activity">
	<input type="hidden" name="#arg[1]" value="clear">
	<input type="submit" value="_(Clear)_">
	<input type="button" value="_(Done)_" onclick="done()">
</form>

<script>
$(function() {
	const pre = document.querySelector('pre.up');
	if (pre) {
		/* Resize function */
		function resize() {
			$('pre.up').height(Math.max(window.innerHeight - 380, 370)).show();
		}

		/* Initial resize and bind event */
		resize();
		$(window).on('resize', resize);
	}
});
</script>
